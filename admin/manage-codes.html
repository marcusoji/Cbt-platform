<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Unlock Codes - Admin</title>
    <link rel="stylesheet" href="../public/css/style.css">
    <link rel="stylesheet" href="../public/css/admin.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="dashboard.html" class="logo">
                    <div class="logo-icon">üë®‚Äçüíº</div>
                    <span>Admin Panel</span>
                </a>
                <nav>
                    <ul>
                        <li><a href="dashboard.html">Dashboard</a></li>
                        <li><a href="manage-codes.html" style="color: var(--primary-color);">Manage Codes</a></li>
                        <li><a href="upload-questions.html">Questions</a></li>
                        <li><a href="users.html">Users</a></li>
                        <li><a href="#" onclick="logout()" class="btn btn-outline">Logout</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="container" style="padding: 2rem 0;">
        <div class="admin-header">
            <h1>Unlock Code Management</h1>
            <p style="color: #6b7280;">Generate and manage premium access codes</p>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Generate New Unlock Codes</h2>
            </div>

            <div id="alert-container"></div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div class="form-group">
                    <label class="form-label">Duration (Months)</label>
                    <input type="number" class="form-input" id="duration" value="9" min="1" max="24">
                    <p style="color: #6b7280; font-size: 0.85rem; margin-top: 0.5rem;">
                        How many months of access
                    </p>
                </div>

                <div class="form-group">
                    <label class="form-label">Quantity</label>
                    <input type="number" class="form-input" id="quantity" value="1" min="1" max="100">
                    <p style="color: #6b7280; font-size: 0.85rem; margin-top: 0.5rem;">
                        Number of codes to generate
                    </p>
                </div>

                <div class="form-group">
                    <label class="form-label">Action</label>
                    <button class="btn btn-primary btn-full" onclick="generateCodes()" id="generateBtn">
                        üé´ Generate Codes
                    </button>
                </div>
            </div>

            <div id="generatedCodesDisplay" style="display: none;">
                <div style="background: #eff6ff; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <h3 style="margin-bottom: 1rem; color: #1e40af;">‚úÖ Codes Generated Successfully!</h3>
                    <div id="generatedCodesList"></div>
                    <button class="btn btn-outline" onclick="copyAllCodes()" style="margin-top: 1rem;">
                        üìã Copy All Codes
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 class="card-title">All Unlock Codes</h2>
                <div style="display: flex; gap: 1rem;">
                    <input type="text" class="form-input" placeholder="Search code/user" id="searchCode">
                    <select class="form-select" id="filterUsed">
                        <option value="all">Show All</option>
                        <option value="active">Active Only</option>
                        <option value="used">Used Only</option>
                    </select>
                </div>
            </div>

            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Access Details</th>
                            <th>Status</th>
                            <th>Generated Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="codesTableBody">
                        <tr><td colspan="5" style="text-align: center; color: #6b7280;">Loading codes...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api'; // Assuming Vercel environment

        async function generateCodes() {
            const durationStr = document.getElementById('duration').value;
            const quantityStr = document.getElementById('quantity').value;
            const genBtn = document.getElementById('generateBtn');
            
            const duration = parseInt(durationStr);
            const quantity = parseInt(quantityStr);

            // FIX: Client-side validation for 400 prevention
            if (isNaN(duration) || isNaN(quantity) || quantity < 1 || duration < 1 || quantity > 100) {
                showAlert('Please ensure duration (1-24 months) and quantity (1-100) are valid numbers.', 'error');
                return;
            }

            genBtn.disabled = true;
            genBtn.textContent = 'Generating...';

            const token = localStorage.getItem('token');

            try {
                const response = await fetch(API_URL + '/admin?action=generate-codes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', // FIX: CRITICAL for POST
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ duration, quantity })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert(`${data.codes.length} codes generated successfully!`, 'success');
                    displayGeneratedCodes(data.codes);
                    loadCodes(); // Refresh the list
                } else {
                    showAlert(data.error || 'Failed to generate codes', 'error');
                }
            } catch (error) {
                console.error('Generate Code Error:', error);
                showAlert('Network error or server unreachable.', 'error');
            } finally {
                genBtn.disabled = false;
                genBtn.textContent = 'üé´ Generate Codes';
            }
        }

        async function loadCodes() {
            const token = localStorage.getItem('token');
            if (!token) return; 

            try {
                // FIX: Corrected action from 'codes' (or empty) to 'get-codes'
                const response = await fetch(API_URL + '/admin?action=get-codes', { 
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const data = await response.json();
                    console.error('Fetch Codes Error:', data.error);
                    throw new Error(data.error || 'Failed to fetch codes');
                }
                
                const data = await response.json();
                displayCodes(data.codes);

            } catch (error) {
                console.error('Error loading codes:', error);
            }
        }

        // --- Helper Functions ---

        function displayGeneratedCodes(codes) {
            const display = document.getElementById('generatedCodesDisplay');
            const list = document.getElementById('generatedCodesList');
            
            list.innerHTML = codes.map(code => `
                <div style="font-family: monospace; font-size: 1.1rem; padding: 0.25rem 0;">${code}</div>
            `).join('');

            display.style.display = 'block';
        }

        function displayCodes(codes) {
            const tableBody = document.getElementById('codesTableBody');
            tableBody.innerHTML = ''; // Clear previous entries

            const filterType = document.getElementById('filterUsed').value;
            const searchText = document.getElementById('searchCode').value.toLowerCase();
            
            const filteredCodes = codes.filter(code => {
                const isUsedMatch = filterType === 'all' || 
                                    (filterType === 'active' && !code.is_used) || 
                                    (filterType === 'used' && code.is_used);

                const searchMatch = code.code.toLowerCase().includes(searchText) ||
                                    (code.users && (code.users.full_name?.toLowerCase().includes(searchText) || code.users.email?.toLowerCase().includes(searchText)));
                
                return isUsedMatch && searchMatch;
            });
            
            if (filteredCodes.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6b7280;">No codes found based on filters.</td></tr>';
                return;
            }

            filteredCodes.forEach(code => {
                const usedStatus = code.is_used 
                    ? `<span class="badge badge-error">Used by ${code.users.full_name || code.users.email}</span>`
                    : '<span class="badge badge-success">Active</span>';
                
                const generatedDate = new Date(code.generated_at).toLocaleDateString();
                
                // Calculate expiry date based on generated_at + duration
                const expiryDateObj = new Date(code.generated_at);
                expiryDateObj.setMonth(expiryDateObj.getMonth() + code.duration);
                const expiryDate = expiryDateObj.toLocaleDateString();

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${code.code}</td>
                    <td>${code.duration} months (Exp: ${expiryDate})</td>
                    <td>${usedStatus}</td>
                    <td>${generatedDate}</td>
                    <td>
                        <button class="btn btn-sm btn-delete" onclick="deleteCode('${code.code}')" ${code.is_used ? 'disabled' : ''}>Delete</button>
                    </td>
                `;
            });
        }
        
        document.getElementById('filterUsed').addEventListener('change', loadCodes);
        document.getElementById('searchCode').addEventListener('input', loadCodes);


        async function deleteCode(codeId) {
            if (!confirm(`Are you sure you want to delete code ${codeId}? This cannot be undone.`)) return;

            const token = localStorage.getItem('token');

            try {
                const response = await fetch(API_URL + `/admin?action=delete-code&codeId=${codeId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    showAlert('Code deleted successfully', 'success');
                    loadCodes();
                } else {
                    const data = await response.json();
                    showAlert(data.error || 'Failed to delete code', 'error');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `
                <div class="alert alert-${type === 'error' ? 'error' : 'success'}">
                    ${message}
                </div>
            `;

            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '../login.html';
        }

        // Check admin access
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!token || user.role !== 'admin') {
            window.location.href = '../login.html';
        }

        // Load codes on page load
        loadCodes();
    </script>
</body>
</html>